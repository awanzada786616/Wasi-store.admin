<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Safe Geolocation + Loader Demo</title>
  <style>
    :root { --bg: #0f1724; --panel:#0b1220; --accent:#16a34a; --muted:#9aa6b2; color-scheme: dark; }
    *{box-sizing:border-box}
    body,html{height:100%;margin:0;font-family:Inter,Segoe UI,Arial,system-ui;background:linear-gradient(180deg,#071020 0%, #051022 100%);color:#e6eef6}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    .card{width:920px;max-width:92%;background:rgba(8,12,20,0.7);border-radius:12px;padding:20px;box-shadow:0 6px 30px rgba(2,6,23,0.7)}
    .row{display:flex;gap:16px}
    .col{flex:1}
    .loader{width:52px;height:52px;border:5px solid rgba(255,255,255,0.12);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:10px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .muted{color:var(--muted)}
    #loading-text{font-weight:600;text-align:center;margin-top:6px}
    .panel{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px}
    .big{font-size:18px;font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    button{background:var(--accent);border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .permission-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(1,3,8,0.75);z-index:50}
    .permission-box{background:#071226;padding:18px;border-radius:10px;text-align:center;color:#eaf6ea}
    a.link{color:#9fe5b4;text-decoration:underline}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;font-size:13px;color:#dbe9f2}
  </style>
</head>
<body>
  <div class="center">
    <div class="card" role="main">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px">
        <div>
          <div class="big">Safe Tracking Demo — Local Display Only</div>
          <div class="small">This demo shows IP & (if allowed) GPS on the page. Nothing is sent anywhere.</div>
        </div>
        <div style="text-align:right">
          <div id="status" class="muted">Status: Initializing…</div>
          <div style="height:8px"></div>
          <button id="refreshBtn">Refresh</button>
        </div>
      </div>

      <div class="row">
        <div class="col panel">
          <div style="display:flex;align-items:center;gap:12px">
            <div>
              <div class="loader" id="loader"></div>
            </div>
            <div style="flex:1">
              <div id="loading-text">Connecting to server...</div>
              <div class="small" style="margin-top:6px">Rotating informational messages while the demo runs.</div>
            </div>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

          <div>
            <div class="small" style="margin-bottom:6px">IP & Approximate Location (via IP):</div>
            <pre id="ip-info">Loading IP info…</pre>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

          <div>
            <div class="small" style="margin-bottom:6px">Precise GPS (requires user permission):</div>
            <pre id="gps-info">No GPS data yet. Click "Request Location" or allow when prompted.</pre>
            <div style="margin-top:10px">
              <button id="requestLocationBtn">Request Location</button>
              <button id="showOverlayBtn" style="background:#0b6fb0;margin-left:8px">Show Permission Overlay</button>
            </div>
          </div>
        </div>

        <div style="width:260px" class="panel">
          <div style="margin-bottom:10px" class="small">Instructions & Notes</div>
          <ul style="padding-left:18px;color:var(--muted);margin:0 0 10px 0">
            <li>Open via HTTPS (or localhost) for Geolocation API to work.</li>
            <li>This demo <strong>does not</strong> send data to Telegram or any external service.</li>
            <li>Use the Refresh button to re-run IP lookup and location attempt.</li>
          </ul>

          <div class="small" style="margin-bottom:6px">Last runtime log:</div>
          <pre id="log">Idle.</pre>
        </div>
      </div>
    </div>
  </div>

  <div class="permission-overlay" id="permissionOverlay">
    <div class="permission-box">
      <h3>Location Access Required</h3>
      <p style="max-width:380px;margin:8px auto 0">Please allow location access in your browser dialog to see GPS coordinates in this demo. This demo only displays the location on this page.</p>
      <div style="margin-top:12px">
        <button id="overlayAllow">OK — Request Location</button>
        <button id="overlayCancel" style="background:#444;margin-left:8px">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --- Safe demo: NO external exfiltration ---
    const loadingMessages = [
      "Connecting to server...",
      "Loading demo assets...",
      "Checking permissions...",
      "Preparing interface...",
      "Ready to request location..."
    ];

    const loadingText = document.getElementById('loading-text');
    const loader = document.getElementById('loader');
    const ipInfoEl = document.getElementById('ip-info');
    const gpsInfoEl = document.getElementById('gps-info');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const refreshBtn = document.getElementById('refreshBtn');
    const requestLocationBtn = document.getElementById('requestLocationBtn');
    const permissionOverlay = document.getElementById('permissionOverlay');
    const showOverlayBtn = document.getElementById('showOverlayBtn');
    const overlayAllow = document.getElementById('overlayAllow');
    const overlayCancel = document.getElementById('overlayCancel');

    let rotateInterval = null;

    function rotateLoadingMessages() {
      let i = 0;
      loadingText.textContent = loadingMessages[0];
      rotateInterval = setInterval(()=>{
        i = (i + 1) % loadingMessages.length;
        loadingText.textContent = loadingMessages[i];
      }, 2500);
    }

    function stopLoader(msg) {
      if (rotateInterval) clearInterval(rotateInterval);
      loadingText.textContent = msg || "Idle";
      loader.style.animation = "none";
      statusEl.textContent = "Status: " + (msg || "Idle");
    }

    async function getIPInfo() {
      try {
        const ipRes = await fetch('https://api.ipify.org?format=json');
        const ipJson = await ipRes.json();
        log('Fetched public IP: ' + (ipJson.ip||'unknown'));
        // Use an IP geo service (ipapi.co)
        const detailsRes = await fetch(`https://ipapi.co/${ipJson.ip}/json/`);
        const details = await detailsRes.json();
        displayIPInfo({ip: ipJson.ip, ...details});
        return { ip: ipJson.ip, ...details };
      } catch (e) {
        displayIPInfo({error: 'Could not fetch IP info: ' + e.message});
        log('IP fetch error: ' + e.message);
        return {};
      }
    }

    function displayIPInfo(data) {
      if (data.error) {
        ipInfoEl.textContent = data.error;
        return;
      }
      const lines = [
        `IP: ${data.ip || 'Unknown'}`,
        `City: ${data.city || 'Unknown'}`,
        `Region: ${data.region || 'Unknown'}`,
        `Country: ${data.country_name || data.country || 'Unknown'}`,
        `Latitude/Longitude (approx): ${data.latitude || 'N/A'} , ${data.longitude || 'N/A'}`,
        `Org/ISP: ${data.org || 'Unknown'}`,
      ];
      if (data.latitude && data.longitude) {
        lines.push(`Google Maps: https://www.google.com/maps?q=${data.latitude},${data.longitude}`);
      }
      ipInfoEl.textContent = lines.join('\n');
    }

    function displayGPS(data) {
      if (!data) {
        gpsInfoEl.textContent = 'No GPS data available.';
        return;
      }
      const lines = [
        `Latitude: ${data.lat}`,
        `Longitude: ${data.lon}`,
        `Accuracy (meters): ${data.accuracy}`,
        `Timestamp: ${data.timestamp}`,
        `Google Maps: https://www.google.com/maps?q=${data.lat},${data.lon}`
      ];
      gpsInfoEl.textContent = lines.join('\n');
    }

    function log(msg){
      const ts = new Date().toLocaleTimeString();
      logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
    }

    function getPreciseLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          log('Geolocation API not supported in this browser.');
          resolve(null);
          return;
        }
        navigator.geolocation.getCurrentPosition(
          position => {
            const p = {
              lat: position.coords.latitude,
              lon: position.coords.longitude,
              accuracy: position.coords.accuracy,
              timestamp: new Date(position.timestamp).toLocaleString()
            };
            log('User allowed geolocation: ' + p.lat + ', ' + p.lon);
            resolve(p);
          },
          error => {
            if (error.code === error.PERMISSION_DENIED) {
              log('User denied geolocation permission.');
            } else {
              log('Geolocation error: ' + (error.message || error.code));
            }
            resolve(null);
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    async function runDemo() {
      rotateLoadingMessages();
      statusEl.textContent = "Status: Running demo...";
      log('Demo started.');
      // IP info (approximate)
      await getIPInfo();
      stopLoader('IP info loaded');
      // Do not automatically request precise GPS — wait for user action
    }

    // Buttons & overlay
    refreshBtn.addEventListener('click', async ()=>{
      loader.style.animation = "spin 1s linear infinite";
      loadingText.textContent = 'Refreshing...';
      log('User clicked refresh.');
      await runDemo();
    });

    requestLocationBtn.addEventListener('click', async ()=>{
      log('User requested location via button.');
      loader.style.animation = "spin 1s linear infinite";
      loadingText.textContent = 'Requesting location...';
      const loc = await getPreciseLocation();
      if (loc) {
        displayGPS(loc);
        stopLoader('GPS obtained');
      } else {
        displayGPS(null);
        stopLoader('No GPS');
      }
    });

    showOverlayBtn.addEventListener('click', ()=> {
      permissionOverlay.style.display = 'flex';
    });
    overlayCancel.addEventListener('click', ()=> {
      permissionOverlay.style.display = 'none';
      log('Permission overlay cancelled by user.');
    });
    overlayAllow.addEventListener('click', async ()=> {
      permissionOverlay.style.display = 'none';
      log('Permission overlay OK clicked.');
      requestLocationBtn.click();
    });

    // Initial run
    window.addEventListener('load', runDemo);
  </script>
</body>
</html>
